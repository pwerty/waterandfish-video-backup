<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototype Viewer - ÎûúÎìúÎßàÌÅ¨ vs ÏõπÏ∫† ÎπÑÍµê</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            height: 100vh;
            overflow: hidden;
        }
        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            color: #333;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 30px;
        }
        .header-title {
            flex-shrink: 0;
        }
        .header-title h1 {
            font-size: 24px;
            font-weight: 300;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        .header-title p {
            font-size: 14px;
            opacity: 0.7;
            color: #34495e;
            margin: 0;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .control-group label {
            color: #2c3e50;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }
        .control-buttons {
            display: flex;
            gap: 5px;
        }
        .control-buttons button {
            padding: 6px 12px;
            font-size: 11px;
        }
        .control-toggles {
            display: flex;
            gap: 15px;
        }
        .control-toggles label {
            color: #2c3e50;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
        }
        .left-panel, .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .left-panel {
            background: rgba(255, 255, 255, 0.95);
            border-right: 2px solid rgba(0, 0, 0, 0.1);
        }
        .right-panel {
            background: rgba(255, 255, 255, 0.95);
        }
        .panel-title {
            background: rgba(52, 73, 94, 0.9);
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 500;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .controls {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .control-row:last-child { margin-bottom: 0; }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .control-group label {
            color: #2c3e50;
            font-size: 12px;
            min-width: 60px;
            font-weight: 500;
        }
        select, input[type="range"] {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.2);
            color: #2c3e50;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        select option {
            background: #fff;
            color: #2c3e50;
        }
        button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        button:active {
            transform: translateY(0);
        }
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #f8f9fa;
        }
        #landmark-canvas-left, #landmark-canvas-right {
            width: 100%;
            height: 100%;
            display: block;
        }
        .webcam-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
        }
        #webcam-video {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        #webcam-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border-radius: 8px;
        }
        .webcam-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
        }
        .status-indicator.active {
            background: #27ae60;
            box-shadow: 0 0 10px #27ae60;
        }
        .info-text {
            color: #7f8c8d;
            font-size: 11px;
            margin-top: 5px;
        }
        .legend {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #2c3e50;
            font-size: 11px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <h1>Prototype Viewer</h1>
                <p>ÎûúÎìúÎßàÌÅ¨ Ïï†ÎãàÎ©îÏù¥ÏÖò vs Ïã§ÏãúÍ∞Ñ ÏõπÏ∫† ÎπÑÍµê</p>
            </div>
            <div class="header-controls">
                <div class="control-toggles">
                    <label><input type="checkbox" id="show-cylinders" checked> ÏõêÍ∏∞Îë•(ÏÑ†)</label>
                    <label><input type="checkbox" id="show-left-hand" checked> Ï¢åÏ∏° ÏÜê</label>
                    <label><input type="checkbox" id="show-right-hand" checked> Ïö∞Ï∏° ÏÜê</label>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <!-- Ï¢åÏ∏° Ìå®ÎÑê: ÎûúÎìúÎßàÌÅ¨ Î∑∞Ïñ¥ -->
        <div class="left-panel">
            <div class="panel-title">3D ÎûúÎìúÎßàÌÅ¨ Î∑∞Ïñ¥ - Ï¢åÏ∏°</div>
            <div class="controls">
                <div class="control-row">
                    <div class="control-group">
                        <label>ÎπÑÎîîÏò§:</label>
                        <select id="video-select-left"></select>
                    </div>
                    <div class="control-group">
                        <label>ÌîÑÎ†àÏûÑ:</label>
                        <span id="current-frame-left">0</span>
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-buttons">
                        <button onclick="previousFrame('left')">‚óÄ</button>
                        <button onclick="playAnimation('left')" id="play-btn-left">‚ñ∂</button>
                        <button onclick="nextFrame('left')">‚ñ∂</button>
                        <button onclick="resetCamera('left')">üîÑ</button>
                    </div>
                    <div class="control-group">
                        <input type="range" id="frame-slider-left" min="0" max="0" value="0" style="width: 120px;" oninput="sliderFrame('left', this.value)">
                    </div>
                    <div class="control-group">
                        <label>ÏÜçÎèÑ:</label>
                        <input type="range" id="speed-left" min="1" max="30" value="5" onchange="updateSpeed('left')" style="width: 80px;">
                        <span id="speed-value-left">5</span>
                    </div>
                </div>
            </div>
            <div class="canvas-container">
                <canvas id="landmark-canvas-left"></canvas>
            </div>
        </div>
        
        <!-- Ïö∞Ï∏° Ìå®ÎÑê: ÎûúÎìúÎßàÌÅ¨ Î∑∞Ïñ¥ -->
        <div class="right-panel">
            <div class="panel-title">3D ÎûúÎìúÎßàÌÅ¨ Î∑∞Ïñ¥ - Ïö∞Ï∏°</div>
            <div class="controls">
                <div class="control-row">
                    <div class="control-group">
                        <label>ÎπÑÎîîÏò§:</label>
                        <select id="video-select-right"></select>
                    </div>
                    <div class="control-group">
                        <label>ÌîÑÎ†àÏûÑ:</label>
                        <span id="current-frame-right">0</span>
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-buttons">
                        <button onclick="previousFrame('right')">‚óÄ</button>
                        <button onclick="playAnimation('right')" id="play-btn-right">‚ñ∂</button>
                        <button onclick="nextFrame('right')">‚ñ∂</button>
                        <button onclick="resetCamera('right')">üîÑ</button>
                    </div>
                    <div class="control-group">
                        <input type="range" id="frame-slider-right" min="0" max="0" value="0" style="width: 120px;" oninput="sliderFrame('right', this.value)">
                    </div>
                    <div class="control-group">
                        <label>ÏÜçÎèÑ:</label>
                        <input type="range" id="speed-right" min="1" max="30" value="5" onchange="updateSpeed('right')" style="width: 80px;">
                        <span id="speed-value-right">5</span>
                    </div>
                </div>
            </div>
            <div class="canvas-container">
                <canvas id="landmark-canvas-right"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Ï¢åÏ∏°/Ïö∞Ï∏° ÎèÖÎ¶ΩÏ†ÅÏù∏ Î∑∞Ïñ¥ ÏÉÅÌÉú
        const viewers = {
            left: {
                scene: null, camera: null, renderer: null,
                poseObjects: [], leftHandObjects: [], rightHandObjects: [],
                poseLines: [], leftHandLines: [], rightHandLines: [],
                currentFrame: 0, isPlaying: false, animationSpeed: 5, animationInterval: null,
                data: null, yaw: 0, pitch: 0, roll: 0,
                isMouseDown: false, lastMouseX: 0, lastMouseY: 0
            },
            right: {
                scene: null, camera: null, renderer: null,
                poseObjects: [], leftHandObjects: [], rightHandObjects: [],
                poseLines: [], leftHandLines: [], rightHandLines: [],
                currentFrame: 0, isPlaying: false, animationSpeed: 5, animationInterval: null,
                data: null, yaw: 0, pitch: 0, roll: 0,
                isMouseDown: false, lastMouseX: 0, lastMouseY: 0
            }
        };
        
        let allData = null;
        const cameraInitPos = { x: -0.388, y: 0.334, z: -0.655 };
        
        // ÏÉâÏÉÅ
        const POSE_COLOR = 0x00b894;
        const LEFT_COLOR = 0x0984e3;
        const RIGHT_COLOR = 0xd63031;
        
        // Ïó∞Í≤∞ Íµ¨Ï°∞
        const POSE_CONNECTIONS = [
            [0,1],[1,2],[2,3],[3,7],[0,4],[4,5],[5,6],[6,8],[9,10],[11,12],[11,13],[13,15],[15,17],[15,19],[15,21],[17,19],[12,14],[14,16],[16,18],[16,20],[16,22],[18,20],[11,23],[12,24],[23,24],[23,25],[24,26],[25,27],[26,28],[27,29],[28,30],[29,31],[30,32],[27,31],[28,32]
        ];
        const HAND_CONNECTIONS = [
            [0,1],[1,2],[2,3],[3,4],
            [0,5],[5,6],[6,7],[7,8],
            [0,9],[9,10],[10,11],[11,12],
            [0,13],[13,14],[14,15],[15,16],
            [0,17],[17,18],[18,19],[19,20],
            [5,9],[9,13],[13,17],[5,17]
        ];
        
        // ÏõπÏ∫† Í¥ÄÎ†® Î≥ÄÏàò
        let webcamStream = null;
        let webcamVideo = null;
        
        // Ï¥àÍ∏∞Ìôî
        window.onload = function() {
            initLandmarkViewer('left');
            initLandmarkViewer('right');
            loadLandmarkData();
        };
        
        // ÎûúÎìúÎßàÌÅ¨ Î∑∞Ïñ¥ Ï¥àÍ∏∞Ìôî
        function initLandmarkViewer(side) {
            const viewer = viewers[side];
            viewer.scene = new THREE.Scene();
            viewer.scene.background = new THREE.Color(0xf8f9fa);
            viewer.camera = new THREE.PerspectiveCamera(75, 1, 0.001, 1000);
            viewer.camera.position.set(cameraInitPos.x, cameraInitPos.y, cameraInitPos.z);
            viewer.yaw = -10.3 * Math.PI / 180;
            viewer.pitch = 178.7 * Math.PI / 180;
            viewer.roll = 0;
            updateCameraDirection(side);
            
            const canvas = document.getElementById(`landmark-canvas-${side}`);
            viewer.renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            viewer.renderer.setSize(canvas.offsetWidth, canvas.offsetHeight);
            viewer.renderer.setClearColor(0xf8f9fa, 1);
            
            const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
            viewer.scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(1, 1, 1);
            viewer.scene.add(directionalLight);
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight2.position.set(-1, 1, -1);
            viewer.scene.add(directionalLight2);
            
            setupEventListeners(side);
            animate(side);
        }
        

        
        // ÎûúÎìúÎßàÌÅ¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function loadLandmarkData() {
            fetch('result/file_list.json')
                .then(response => response.json())
                .then(fileList => {
                    const jsonFiles = fileList.landmark_files || [];
                    const loadPromises = jsonFiles.map(filename => 
                        fetch(`result/${filename}`)
                            .then(response => response.json())
                            .then(data => ({ filename, data }))
                            .catch(() => null)
                    );
                    return Promise.all(loadPromises);
                })
                .then(results => {
                    const validResults = results.filter(result => result !== null);
                    allData = {};
                    validResults.forEach(({ filename, data }) => {
                        const baseName = filename.replace('_landmarks.json', '');
                        allData[baseName] = data;
                    });
                    
                    // Ï¢åÏ∏°/Ïö∞Ï∏° ÏÑ†ÌÉù ÏòµÏÖò ÏÉùÏÑ±
                    ['left', 'right'].forEach(side => {
                        const select = document.getElementById(`video-select-${side}`);
                        Object.keys(allData).forEach(filename => {
                            const opt = document.createElement('option');
                            opt.value = filename;
                            opt.textContent = filename;
                            select.appendChild(opt);
                        });
                        
                        select.onchange = function() {
                            viewers[side].data = allData[select.value];
                            document.getElementById(`frame-slider-${side}`).max = viewers[side].data.pose.length - 1;
                            loadFrame(side, 0);
                        };
                        
                        if (Object.keys(allData).length > 0) {
                            select.value = Object.keys(allData)[0];
                            select.onchange();
                        }
                    });
                })
                .catch(error => console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error));
        }
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupEventListeners(side) {
            document.getElementById('show-cylinders').addEventListener('change', () => {
                loadFrame('left', viewers.left.currentFrame);
                loadFrame('right', viewers.right.currentFrame);
            });
            document.getElementById('show-left-hand').addEventListener('change', () => {
                loadFrame('left', viewers.left.currentFrame);
                loadFrame('right', viewers.right.currentFrame);
            });
            document.getElementById('show-right-hand').addEventListener('change', () => {
                loadFrame('left', viewers.left.currentFrame);
                loadFrame('right', viewers.right.currentFrame);
            });
        }
        
        // Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ
        function animate(side) {
            const viewer = viewers[side];
            function loop() {
                requestAnimationFrame(loop);
                viewer.renderer.render(viewer.scene, viewer.camera);
            }
            loop();
        }
        
        // Ïπ¥Î©îÎùº Î∞©Ìñ• ÏóÖÎç∞Ïù¥Ìä∏
        function updateCameraDirection(side) {
            const viewer = viewers[side];
            viewer.camera.rotation.order = 'YXZ';
            viewer.camera.rotation.y = viewer.yaw;
            viewer.camera.rotation.x = viewer.pitch;
            viewer.camera.rotation.z = viewer.roll;
        }
        

        

        
        // ÌîÑÎ†àÏûÑ Î°úÎìú
        function loadFrame(side, frameIndex) {
            const viewer = viewers[side];
            if (!viewer.data) return;
            viewer.currentFrame = frameIndex;
            clearScene(side);
            
            const showCylinders = document.getElementById('show-cylinders').checked;
            const showLeftHand = document.getElementById('show-left-hand').checked;
            const showRightHand = document.getElementById('show-right-hand').checked;
            
            function rotateLandmark(lm) {
                return [-lm[0], lm[1], -lm[2]];
            }
            
            // Left Hand
            if (viewer.data.left_hand && viewer.data.left_hand[frameIndex] && showLeftHand) {
                const rotatedLeftHand = viewer.data.left_hand[frameIndex].map(rotateLandmark);
                if (showCylinders) {
                    drawConnectionsCylinder(side, rotatedLeftHand, HAND_CONNECTIONS, LEFT_COLOR, viewer.leftHandLines);
                }
            }
            
            // Right Hand
            if (viewer.data.right_hand && viewer.data.right_hand[frameIndex] && showRightHand) {
                const rotatedRightHand = viewer.data.right_hand[frameIndex].map(rotateLandmark);
                if (showCylinders) {
                    drawConnectionsCylinder(side, rotatedRightHand, HAND_CONNECTIONS, RIGHT_COLOR, viewer.rightHandLines);
                }
            }
            
            document.getElementById(`current-frame-${side}`).textContent = viewer.currentFrame;
            document.getElementById(`frame-slider-${side}`).value = viewer.currentFrame;
        }
        
        // Ïî¨ ÌÅ¥Î¶¨Ïñ¥
        function clearScene(side) {
            const viewer = viewers[side];
            [...viewer.poseObjects, ...viewer.leftHandObjects, ...viewer.rightHandObjects].forEach(obj => {
                viewer.scene.remove(obj);
                if (obj.geometry) obj.geometry.dispose();
                if (obj.material) obj.material.dispose();
            });
            [...viewer.poseLines, ...viewer.leftHandLines, ...viewer.rightHandLines].forEach(line => {
                viewer.scene.remove(line);
                if (line.geometry) line.geometry.dispose();
                if (line.material) line.material.dispose();
            });
            viewer.poseObjects = []; viewer.leftHandObjects = []; viewer.rightHandObjects = [];
            viewer.poseLines = []; viewer.leftHandLines = []; viewer.rightHandLines = [];
        }
        
        // Ïó∞Í≤∞ÏÑ† Í∑∏Î¶¨Í∏∞
        function drawConnectionsCylinder(side, landmarks, connections, color, lineArray) {
            const viewer = viewers[side];
            connections.forEach(connection => {
                if (connection[0] < landmarks.length && connection[1] < landmarks.length) {
                    const start = landmarks[connection[0]];
                    const end = landmarks[connection[1]];
                    const startVec = new THREE.Vector3(start[0], start[1], start[2]);
                    const endVec = new THREE.Vector3(end[0], end[1], end[2]);
                    const distance = startVec.distanceTo(endVec);
                    
                    const geometry = new THREE.CylinderGeometry(0.008, 0.008, distance, 12);
                    const material = new THREE.MeshLambertMaterial({ 
                        color: color, 
                        transparent: true, 
                        opacity: 0.9,
                        emissive: color,
                        emissiveIntensity: 0.1
                    });
                    const cylinder = new THREE.Mesh(geometry, material);
                    cylinder.position.copy(startVec).add(endVec).multiplyScalar(0.5);
                    const up = new THREE.Vector3(0, 1, 0);
                    const quaternion = new THREE.Quaternion().setFromUnitVectors(up, new THREE.Vector3().subVectors(endVec, startVec).normalize());
                    cylinder.quaternion.copy(quaternion);
                    viewer.scene.add(cylinder);
                    lineArray.push(cylinder);
                }
            });
        }
        
        // Ïª®Ìä∏Î°§ Ìï®ÏàòÎì§
        function previousFrame(side) {
            const viewer = viewers[side];
            if (viewer.currentFrame > 0) {
                loadFrame(side, viewer.currentFrame - 1);
            }
        }
        
        function nextFrame(side) {
            const viewer = viewers[side];
            if (viewer.data && viewer.currentFrame < viewer.data.pose.length - 1) {
                loadFrame(side, viewer.currentFrame + 1);
            }
        }
        
        function playAnimation(side) {
            const viewer = viewers[side];
            if (viewer.isPlaying) {
                viewer.isPlaying = false;
                if (viewer.animationInterval) {
                    clearInterval(viewer.animationInterval);
                    viewer.animationInterval = null;
                }
                document.getElementById(`play-btn-${side}`).textContent = '‚ñ∂';
            } else {
                viewer.isPlaying = true;
                document.getElementById(`play-btn-${side}`).textContent = '‚è∏';
                viewer.animationInterval = setInterval(() => {
                    if (viewer.data && viewer.currentFrame < viewer.data.pose.length - 1) {
                        loadFrame(side, viewer.currentFrame + 1);
                    } else {
                        loadFrame(side, 0);
                    }
                }, 1000 / viewer.animationSpeed);
            }
        }
        
        function resetCamera(side) {
            const viewer = viewers[side];
            viewer.camera.position.set(cameraInitPos.x, cameraInitPos.y, cameraInitPos.z);
            viewer.yaw = -10.3 * Math.PI / 180;
            viewer.pitch = 178.7 * Math.PI / 180;
            viewer.roll = 0;
            updateCameraDirection(side);
        }
        
        function sliderFrame(side, val) {
            loadFrame(side, parseInt(val));
        }
        
        function updateSpeed(side) {
            const viewer = viewers[side];
            viewer.animationSpeed = parseInt(document.getElementById(`speed-${side}`).value);
            document.getElementById(`speed-value-${side}`).textContent = viewer.animationSpeed;
            if (viewer.isPlaying && viewer.animationInterval) {
                clearInterval(viewer.animationInterval);
                playAnimation(side);
            }
        }
        
        // ÏúàÎèÑÏö∞ Î¶¨ÏÇ¨Ïù¥Ï¶à Ï≤òÎ¶¨
        window.addEventListener('resize', () => {
            ['left', 'right'].forEach(side => {
                const canvas = document.getElementById(`landmark-canvas-${side}`);
                const viewer = viewers[side];
                viewer.camera.aspect = canvas.offsetWidth / canvas.offsetHeight;
                viewer.camera.updateProjectionMatrix();
                viewer.renderer.setSize(canvas.offsetWidth, canvas.offsetHeight);
            });
        });
        
        // ÏõπÏ∫† Í¥ÄÎ†® Ï†úÍ±∞Îêú Î≥ÄÏàòÎì§
        let webcamStream = null;
        let webcamVideo = null;
    </script>
</body>
</html> 